steps:
  - name: Check out
    uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"
      cache: "pip"

  - name: System deps for Tkinter
    run: |
      sudo apt-get update
      sudo apt-get install -y python3-tk xvfb

  - name: Install project (dev)
    run: |
      python -m pip install --upgrade pip
      pip install -e .[dev]
      pip install pyinstaller

  # Auto-fix imports/format, then fail if changes were needed (forces devs to commit fixes)
  - name: Ruff (auto-fix)
    run: |
      ruff check . --fix
      git diff --exit-code

  - name: Run tests (headless-friendly)
    run: |
      xvfb-run -a pytest -q

  # Build only when: manual dispatch, or pushing a tag, or commit message contains [build]
  - name: Build (PyInstaller)
    if: >
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/') ||
      contains(github.event.head_commit.message, '[build]')
    run: |
      pyinstaller --onefile --windowed \
        --name fimpad \
        --hidden-import tkinter \
        --hidden-import tkinter.scrolledtext \
        fimpad/__main__.py
      ls -lh dist/

  - name: Upload binary artifact
    if: >
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/') ||
      contains(github.event.head_commit.message, '[build]')
    uses: actions/upload-artifact@v4
    with:
      name: fimpad-linux-${{ github.sha }}
      path: dist/fimpad
      if-no-files-found: error
